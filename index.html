<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Play Sudoku Like a Pro</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%233182ce'/%3E%3Cpath d='M11 6v20M21 6v20M6 11h20M6 21h20' stroke='white' stroke-width='3' stroke-linecap='round'/%3E%3C/svg%3E">
    <style>
        :root {
            --bg-color: #f4f7f6;
            --board-bg: #ffffff;
            --line-color: #34495e;
            --light-line: #e2e8f0;
            --highlight-color: #eef2f7;
            --same-num-color: #e3f2fd;
            --selected-color: #4299e1;
            --text-color: #2d3748;
            --primary-color: #3182ce;
            --error-color: #e53e3e;
            --error-bg-color: #fff5f5;
            --fixed-num-color: #1a202c;
            --user-num-color: #2b6cb0;
            --candidate-color: #718096;
            
            /* éš¾åº¦é¢œè‰² */
            --easy-color: #48bb78;
            --medium-color: #4299e1;
            --hard-color: #ed8936;
            --expert-color: #f56565;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            color: var(--text-color);
            touch-action: manipulation; 
            padding: 20px;
            box-sizing: border-box;
        }

        h1 { 
            margin: 0 0 20px 0; 
            font-weight: 300;
            letter-spacing: 2px;
            color: #4a5568;
        }

        /* --- é¡¶éƒ¨æ§åˆ¶åŒº --- */
        .top-bar {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 600px;
            margin-bottom: 25px;
        }

        .difficulty-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            width: 100%;
        }

        .diff-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 4px; /* å‡å°å·¦å³å†…è¾¹è·ä»¥é€‚åº”æ‰‹æœº */
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            min-width: 0; /* é˜²æ­¢Flexå­å…ƒç´ æº¢å‡º */
        }

        .diff-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .diff-btn:active { transform: scale(0.98); }
        
        .diff-icon { width: 28px; height: 28px; margin-bottom: 4px; flex-shrink: 0; }
        .diff-text { 
            font-size: 12px; 
            font-weight: 600; 
            color: #718096; 
            white-space: nowrap; /* é˜²æ­¢æ–‡å­—æ¢è¡Œ */
        }
        
        .diff-btn.active { border-color: var(--primary-color); background-color: #ebf8ff; }
        
        .diff-btn:nth-child(1) .diff-icon { fill: var(--easy-color); }
        .diff-btn:nth-child(2) .diff-icon { fill: var(--medium-color); }
        .diff-btn:nth-child(3) .diff-icon { fill: var(--hard-color); }
        .diff-btn:nth-child(4) .diff-icon { fill: var(--expert-color); }

        /* --- æ¸¸æˆä¸»å®¹å™¨ --- */
        .game-container {
            display: flex;
            gap: 30px;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        /* æ•°ç‹¬ç›˜ */
        .game-board {
            display: grid;
            grid-template-columns: repeat(9, 46px);
            grid-template-rows: repeat(9, 46px);
            background-color: var(--line-color);
            gap: 1px;
            border: 2px solid var(--line-color);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .cell {
            background-color: var(--board-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 22px;
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: background-color 0.05s;
            padding: 0;
        }

        .cell.border-bottom { border-bottom: 2px solid var(--line-color); }
        .cell.border-right { border-right: 2px solid var(--line-color); }

        /* å€™é€‰æ•° */
        .candidates-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .candidate-num {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 9px;
            color: var(--candidate-color);
            line-height: 1;
        }

        /* å•å…ƒæ ¼çŠ¶æ€ */
        .cell.highlight { background-color: var(--highlight-color); }
        .cell.same-number { background-color: var(--same-num-color); }
        .cell.selected { background-color: var(--selected-color); color: white; }
        .cell.selected .candidate-num { color: rgba(255,255,255, 0.9); }
        .cell.fixed { font-weight: 700; color: var(--fixed-num-color); }
        .cell.user-input { color: var(--user-num-color); font-weight: 600; }
        .cell.selected.fixed, .cell.selected.user-input { color: white; }
        .cell.error { background-color: var(--error-bg-color) !important; color: var(--error-color) !important; }

        /* --- å³ä¾§é¢æ¿ (é”®ç›˜ + è®¾ç½®) --- */
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .numpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* ä¿æŒ3åˆ—ç­‰å®½ */
            gap: 10px;
        }
        
        .num-btn {
            padding: 0;
            height: 50px; /* ç»Ÿä¸€é«˜åº¦ */
            font-size: 24px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 600;
            color: var(--text-color);
            box-shadow: 0 3px 0 #cbd5e0;
            transition: all 0.1s;
            cursor: pointer;
            outline: none;
        }

        .num-btn:active:not(:disabled) { transform: translateY(3px); box-shadow: 0 0 0 #cbd5e0; }
        .num-btn.clear, .num-btn.undo { background-color: #edf2f7; font-size: 16px; color: #4a5568; font-weight: normal; }
        
        /* æ¸…é™¤æŒ‰é’®è·¨è¶Š2åˆ—ï¼Œæ’¤é”€æŒ‰é’®è·¨è¶Š1åˆ—ï¼Œæ­£å¥½å¡«æ»¡3åˆ—çš„å®½åº¦ */
        .num-btn.clear { grid-column: span 2; }
        .num-btn.undo { grid-column: span 1; }
        
        .num-btn:disabled.completed {
            background-color: transparent;
            border-color: transparent;
            box-shadow: none;
            cursor: default;
            transform: none;
        }
        
        .completed-svg {
            width: 28px;
            height: 28px;
            fill: #48bb78;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* --- è®¾ç½®é¢æ¿ --- */
        .settings-panel {
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            box-sizing: border-box;
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: #4a5568;
            font-weight: 500;
        }

        /* Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #cbd5e0;
            transition: .3s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(20px); }

        @keyframes popIn {
            from { transform: scale(0); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .status {
            height: 24px;
            font-size: 15px;
            color: var(--primary-color);
            font-weight: 600;
            text-align: center;
        }

        /* --- å“åº”å¼è°ƒæ•´ (é’ˆå¯¹æ‰‹æœºç«¯) --- */
        @media (max-width: 850px) {
            .game-container { 
                flex-direction: column; 
                align-items: center; 
                gap: 20px; 
                width: 100%;
            }

            /* æ•°ç‹¬ç›˜è‡ªé€‚åº” */
            .game-board {
                grid-template-columns: repeat(9, 10.5vw); /* ç¨å¾®æ”¾å¤§æ ¼å­ */
                grid-template-rows: repeat(9, 10.5vw);
                max-width: 94.5vw; /* é˜²æ­¢æº¢å‡º */
                box-shadow: 0 5px 10px rgba(0,0,0,0.05);
            }
            .cell { font-size: 18px; }
            .candidate-num { font-size: 8px; }
            
            /* é”®ç›˜åŒºåŸŸè‡ªé€‚åº” */
            .right-panel { 
                width: 94.5vw; /* ä¸æ•°ç‹¬ç›˜åŒå®½ */
                max-width: none;
            }

            .numpad {
                /* å¼ºåˆ¶3åˆ—å¸ƒå±€ï¼Œ1-9å æ®å‰3è¡Œ */
                grid-template-columns: repeat(3, 1fr); 
                /* è‡ªåŠ¨è¡Œé«˜ */
                gap: 8px;
                width: 100%;
            }
            
            .num-btn { 
                height: 55px; /* æ‰‹æœºä¸ŠæŒ‰é’®ç¨å¾®é«˜ä¸€ç‚¹æ›´æ˜“ç‚¹ */
                font-size: 22px; 
                border-radius: 12px;
            }

            /* é¡¶éƒ¨æ å®½åº¦ */
            .top-bar { width: 94.5vw; max-width: none; margin-bottom: 15px; }
            .difficulty-selector { gap: 8px; }
            
            /* ç¡®ä¿æ–‡å­—æ˜¾ç¤º */
            .diff-text { display: block; font-size: 11px; }
            .diff-icon { width: 24px; height: 24px; }
        }
    </style>
</head>
<body>

    <h1>SUDOKU</h1>

    <div class="top-bar">
        <div class="difficulty-selector">
            <button class="diff-btn" onclick="initGame(30, this)">
                <svg class="diff-icon" viewBox="0 0 24 24">
                    <path d="M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10s10-4.48,10-10S17.52,2,12,2z M12,20c-4.41,0-8-3.59-8-8s3.59-8,8-8s8,3.59,8,8S16.41,20,12,20z"/>
                    <path d="M8.5,9.5c0,0.83,0.67,1.5,1.5,1.5S11.5,10.33,11.5,9.5S10.83,8,10,8S8.5,8.67,8.5,9.5z M14,9.5c0,0.83,0.67,1.5,1.5,1.5S17,10.33,17,9.5S16.33,8,15.5,8S14,8.67,14,9.5z M12,17.5c2.33,0,4.31-1.46,5.11-3.5H6.89C7.69,16.04,9.67,17.5,12,17.5z"/>
                </svg>
                <span class="diff-text">ç®€å•</span>
            </button>

            <button class="diff-btn" onclick="initGame(40, this)">
                <svg class="diff-icon" viewBox="0 0 24 24">
                    <path d="M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10s10-4.48,10-10S17.52,2,12,2z M12,20c-4.41,0-8-3.59-8-8s3.59-8,8-8s8,3.59,8,8S16.41,20,12,20z"/>
                    <path d="M8.5,9.5c0,0.83,0.67,1.5,1.5,1.5S11.5,10.33,11.5,9.5S10.83,8,10,8S8.5,8.67,8.5,9.5z M14,9.5c0,0.83,0.67,1.5,1.5,1.5S17,10.33,17,9.5S16.33,8,15.5,8S14,8.67,14,9.5z M8,14.5h8v1.5H8V14.5z"/>
                </svg>
                <span class="diff-text">ä¸­ç­‰</span>
            </button>

            <button class="diff-btn" onclick="initGame(50, this)">
                <svg class="diff-icon" viewBox="0 0 24 24">
                    <path d="M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10s10-4.48,10-10S17.52,2,12,2z M12,20c-4.41,0-8-3.59-8-8s3.59-8,8-8s8,3.59,8,8S16.41,20,12,20z"/>
                    <path d="M8.5,9.5c0,0.83,0.67,1.5,1.5,1.5S11.5,10.33,11.5,9.5S10.83,8,10,8S8.5,8.67,8.5,9.5z M14,9.5c0,0.83,0.67,1.5,1.5,1.5S17,10.33,17,9.5S16.33,8,15.5,8S14,8.67,14,9.5z M12,13.5c-2.33,0-4.31,1.46-5.11,3.5h10.22C16.31,14.96,14.33,13.5,12,13.5z"/>
                </svg>
                <span class="diff-text">å›°éš¾</span>
            </button>

            <button class="diff-btn" onclick="initGame(60, this)">
                <svg class="diff-icon" viewBox="0 0 24 24">
                    <path d="M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10s10-4.48,10-10S17.52,2,12,2z M12,20c-4.41,0-8-3.59-8-8s3.59-8,8-8s8,3.59,8,8S16.41,20,12,20z"/>
                    <polygon points="7.5,9 10.5,11 7.5,13 7.5,11.5 9,11 7.5,10.5"/>
                    <polygon points="16.5,9 13.5,11 16.5,13 16.5,11.5 15,11 16.5,10.5"/>
                    <path d="M8,15 l2,2 l2,-2 l2,2 l2,-2 v1.5 l-2,2 l-2,-2 l-2,2 l-2,-2 Z"/>
                </svg>
                <span class="diff-text">ä¸“å®¶</span>
            </button>
        </div>
    </div>

    <div class="game-container">
        <div class="left-panel">
            <div id="board" class="game-board"></div>
        </div>
        
        <div class="right-panel">
            <div class="numpad">
                <button id="btn-1" class="num-btn" onclick="fillNumber(1)">1</button>
                <button id="btn-2" class="num-btn" onclick="fillNumber(2)">2</button>
                <button id="btn-3" class="num-btn" onclick="fillNumber(3)">3</button>
                <button id="btn-4" class="num-btn" onclick="fillNumber(4)">4</button>
                <button id="btn-5" class="num-btn" onclick="fillNumber(5)">5</button>
                <button id="btn-6" class="num-btn" onclick="fillNumber(6)">6</button>
                <button id="btn-7" class="num-btn" onclick="fillNumber(7)">7</button>
                <button id="btn-8" class="num-btn" onclick="fillNumber(8)">8</button>
                <button id="btn-9" class="num-btn" onclick="fillNumber(9)">9</button>
                <button class="num-btn clear" onclick="fillNumber(0)">æ¸…é™¤</button>
                <button class="num-btn undo" onclick="undoLastMove()">æ’¤é”€</button>
            </div>

            <div class="settings-panel">
                <label class="setting-row">
                    <span>æ˜¾ç¤ºå€™é€‰æ•°</span>
                    <label class="switch">
                        <input type="checkbox" id="toggleCandidates" onchange="renderBoard()">
                        <span class="slider"></span>
                    </label>
                </label>
            </div>
        </div>
    </div>

    <div class="status" id="status-msg"></div>

    <script>
        let boardArray = [];
        let solutionArray = [];
        let fixedCells = [];
        let selectedIndex = -1;
        let history = [];
        const MAX_HISTORY = 50;
        const checkmarkSVG = `<svg class="completed-svg" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>`;

        document.addEventListener('DOMContentLoaded', () => {
            createBoardDOM();
            const firstBtn = document.querySelector('.diff-btn');
            initGame(30, firstBtn);
            document.addEventListener('keydown', handleKeyPress);
        });

        function createBoardDOM() {
            const boardDiv = document.getElementById('board');
            boardDiv.innerHTML = '';
            for (let i = 0; i < 81; i++) {
                let cell = document.createElement('div');
                cell.classList.add('cell');
                cell.dataset.index = i;
                const row = Math.floor(i / 9);
                const col = i % 9;
                if (col === 2 || col === 5) cell.classList.add('border-right');
                if (row === 2 || row === 5) cell.classList.add('border-bottom');
                cell.addEventListener('click', () => selectCell(i));
                boardDiv.appendChild(cell);
            }
        }

        function initGame(difficulty, btnElement) {
            document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
            if(btnElement) btnElement.classList.add('active');

            clearStatus();
            selectedIndex = -1;
            boardArray = new Array(81).fill(0);
            solutionArray = new Array(81).fill(0);
            fixedCells = [];
            history = [];

            fillDiagonal();
            solve(solutionArray);

            boardArray = [...solutionArray];
            removeDigits(difficulty);

            renderBoard();
        }

        function fillDiagonal() {
            for (let i = 0; i < 9; i = i + 3) fillBox(i, i);
        }

        function fillBox(row, col) {
            let num;
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    do {
                        num = Math.floor(Math.random() * 9) + 1;
                    } while (!isSafeBox(row, col, num));
                    solutionArray[(row + i) * 9 + (col + j)] = num;
                }
            }
        }

        function isSafeBox(rowStart, colStart, num) {
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    if (solutionArray[(rowStart + i) * 9 + (colStart + j)] === num) return false;
                }
            }
            return true;
        }

        function isSafe(board, row, col, num) {
            for (let x = 0; x < 9; x++) if (board[row * 9 + x] === num) return false;
            for (let x = 0; x < 9; x++) if (board[x * 9 + col] === num) return false;
            let startRow = row - row % 3, startCol = col - col % 3;
            for (let i = 0; i < 3; i++)
                for (let j = 0; j < 3; j++)
                    if (board[(startRow + i) * 9 + (startCol + j)] === num) return false;
            return true;
        }

        function solve(board) {
            for (let i = 0; i < 81; i++) {
                if (board[i] === 0) {
                    for (let num = 1; num <= 9; num++) {
                        const row = Math.floor(i / 9);
                        const col = i % 9;
                        if (isSafe(board, row, col, num)) {
                            board[i] = num;
                            if (solve(board)) return true;
                            board[i] = 0;
                        }
                    }
                    return false;
                }
            }
            return true;
        }

        function removeDigits(count) {
            let attempts = count;
            let cellIndices = Array.from({length: 81}, (_, i) => i);
            shuffleArray(cellIndices);
            for (let i = 0; i < cellIndices.length && attempts > 0; i++) {
                let idx = cellIndices[i];
                if (boardArray[idx] !== 0) {
                    boardArray[idx] = 0;
                    attempts--;
                }
            }
            for (let i = 0; i < 81; i++) {
                if (boardArray[i] !== 0) fixedCells.push(i);
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function renderBoard() {
            const showCandidates = document.getElementById('toggleCandidates').checked;
            const cells = document.querySelectorAll('.cell');
            
            cells.forEach((cell, i) => {
                cell.className = 'cell'; 
                const row = Math.floor(i / 9);
                const col = i % 9;
                if (col === 2 || col === 5) cell.classList.add('border-right');
                if (row === 2 || row === 5) cell.classList.add('border-bottom');
                cell.innerHTML = '';

                if (boardArray[i] !== 0) {
                    cell.textContent = boardArray[i];
                    if (fixedCells.includes(i)) {
                        cell.classList.add('fixed');
                    } else {
                        cell.classList.add('user-input');
                        if (boardArray[i] !== solutionArray[i]) {
                            cell.classList.add('error');
                        }
                    }
                } else {
                    if (showCandidates) {
                        const candidatesGrid = document.createElement('div');
                        candidatesGrid.className = 'candidates-grid';
                        for (let num = 1; num <= 9; num++) {
                            const candidateSpan = document.createElement('div');
                            candidateSpan.className = 'candidate-num';
                            if (isSafe(boardArray, row, col, num)) {
                                candidateSpan.textContent = num;
                            }
                            candidatesGrid.appendChild(candidateSpan);
                        }
                        cell.appendChild(candidatesGrid);
                    }
                }
            });
            highlightCells();
            updateNumpadState(); 
        }

        function updateNumpadState() {
            const counts = Array(10).fill(0);
            boardArray.forEach(num => counts[num]++);
            for (let i = 1; i <= 9; i++) {
                const btn = document.getElementById(`btn-${i}`);
                if (!btn) continue;
                if (counts[i] >= 9) {
                    btn.classList.add('completed');
                    btn.disabled = true;
                    btn.innerHTML = checkmarkSVG;
                } else {
                    btn.classList.remove('completed');
                    btn.disabled = false;
                    btn.innerHTML = `${i}`;
                }
            }
        }

        function selectCell(index) {
            selectedIndex = index;
            renderBoard();
        }

        function highlightCells() {
            const cells = document.querySelectorAll('.cell');
            cells.forEach(c => c.classList.remove('selected', 'highlight', 'same-number'));
            if (selectedIndex === -1) return;

            const selectedVal = boardArray[selectedIndex];
            const currentRow = Math.floor(selectedIndex / 9);
            const currentCol = selectedIndex % 9;

            let rowsToHighlight = new Set([currentRow]);
            let colsToHighlight = new Set([currentCol]);

            if (selectedVal !== 0) {
                boardArray.forEach((num, index) => {
                    if (num === selectedVal) {
                        rowsToHighlight.add(Math.floor(index / 9));
                        colsToHighlight.add(index % 9);
                    }
                });
            }

            cells.forEach((c, i) => {
                const r = Math.floor(i / 9);
                const cIdx = i % 9;
                if (rowsToHighlight.has(r) || colsToHighlight.has(cIdx)) c.classList.add('highlight');
                if (selectedVal !== 0 && boardArray[i] === selectedVal) c.classList.add('same-number');
                if (i === selectedIndex) c.classList.add('selected');
            });
        }

        function handleKeyPress(e) {
            if (selectedIndex === -1) return;
            const row = Math.floor(selectedIndex / 9);
            const col = selectedIndex % 9;
            if (e.key === 'ArrowUp') { selectCell(row > 0 ? selectedIndex - 9 : selectedIndex); e.preventDefault(); }
            else if (e.key === 'ArrowDown') { selectCell(row < 8 ? selectedIndex + 9 : selectedIndex); e.preventDefault(); }
            else if (e.key === 'ArrowLeft') { selectCell(col > 0 ? selectedIndex - 1 : selectedIndex); e.preventDefault(); }
            else if (e.key === 'ArrowRight') { selectCell(col < 8 ? selectedIndex + 1 : selectedIndex); e.preventDefault(); }
            else if (e.key >= '1' && e.key <= '9') { fillNumber(parseInt(e.key)); }
            else if (e.key === 'Backspace' || e.key === 'Delete') { fillNumber(0); }
        }

        function fillNumber(num) {
            if (selectedIndex === -1) {
                updateStatus("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ ¼å­ï¼");
                return;
            }
            if (fixedCells.includes(selectedIndex)) {
                updateStatus("ä¸èƒ½ä¿®æ”¹é¢˜ç›®é¢„è®¾çš„æ•°å­—ï¼");
                return;
            }
            
            const oldValue = boardArray[selectedIndex];
            if (oldValue === num) return;

            history.push({ index: selectedIndex, oldValue: oldValue, newValue: num });
            if (history.length > MAX_HISTORY) history.shift();

            boardArray[selectedIndex] = num;
            renderBoard();
            
            if (num !== 0 && num !== solutionArray[selectedIndex]) {
                 updateStatus("æ•°å­—ä¸æ­£ç¡®ï¼", true);
            } else if (num !== 0) {
                 document.getElementById('status-msg').textContent = "";
            }
            
            if (!boardArray.includes(0) && checkWin()) {
                updateStatus("ğŸ‰ æ­å–œä½ ï¼Œè§£é¢˜æˆåŠŸï¼");
            }
        }

        function undoLastMove() {
            if (history.length === 0) {
                updateStatus("æ²¡æœ‰å¯ä»¥æ’¤é”€çš„æ“ä½œäº†ï¼");
                return;
            }
            const lastMove = history.pop();
            const { index, oldValue } = lastMove;
            boardArray[index] = oldValue;
            selectedIndex = index;
            renderBoard();
            updateStatus("å·²æ’¤é”€ä¸Šä¸€æ­¥æ“ä½œã€‚");
        }

        function checkWin() {
            for (let i = 0; i < 81; i++) {
                if (boardArray[i] !== solutionArray[i]) return false;
            }
            return true;
        }

        function updateStatus(msg, isError = false) {
            const el = document.getElementById('status-msg');
            el.textContent = msg;
            el.style.color = isError ? 'var(--error-color)' : 'var(--primary-color)';
            if (!isError && msg.includes("æ­å–œ")) {} else {
                setTimeout(() => { el.textContent = ''; }, 2000);
            }
        }

        function clearStatus() {
            document.getElementById('status-msg').textContent = '';
        }
    </script>
</body>
</html>
